<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Аналитика по двойкам и успеваемости</title>

  <!-- XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f6fb;
      color: #111827;
    }
    header {
      padding: 16px 24px;
      background: linear-gradient(90deg, #15803d, #16a34a);
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
    }
    header small {
      font-size: 12px;
      opacity: 0.9;
    }
    .container {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 16px;
      padding: 16px;
      box-sizing: border-box;
    }
    .panel {
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
      padding: 14px 16px;
      box-sizing: border-box;
    }
    .panel h2 {
      font-size: 16px;
      margin: 0 0 8px 0;
    }
    .panel h3 {
      font-size: 14px;
      margin: 8px 0;
    }
    .sidebar label {
      font-size: 13px;
      font-weight: 600;
      margin-top: 10px;
      display: block;
    }
    .sidebar select,
    .sidebar input[type="file"] {
      width: 100%;
      padding: 6px 8px;
      margin-top: 4px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 12px;
      box-sizing: border-box;
      background: #f9fafb;
    }
    .sidebar input[type="file"] {
      padding: 3px;
    }
    .sidebar .hint {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }
    .bad-news {
      color: #b91c1c;
      font-size: 13px;
      margin-top: 8px;
    }
    hr {
      margin: 12px 0;
      border: none;
      border-top: 1px solid #e5e7eb;
    }
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 10px;
    }
    .kpi {
      background: #f9fafb;
      border-radius: 10px;
      padding: 8px 10px;
    }
    .kpi-label {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .kpi-value {
      font-size: 16px;
      font-weight: 700;
    }
    .kpi-sub {
      font-size: 11px;
      color: #6b7280;
      margin-top: 2px;
    }
    .main-grid-2 {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 12px;
      margin-top: 8px;
    }
    .table-wrapper {
      max-height: 260px;
      overflow-y: auto;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 4px 6px;
      text-align: left;
    }
    th {
      background: #f9fafb;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .footer-note {
      font-size: 11px;
      color: #6b7280;
      margin-top: 6px;
    }
    #geo-map {
      height: 520px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      margin-top: 6px;
      background: #dcfce7; /* светло-зеленый фон под картой */
    }
    .geo-legend {
      font-size: 11px;
      margin-top: 4px;
      color: #4b5563;
    }
    .geo-legend span {
      display: inline-flex;
      align-items: center;
      margin-right: 8px;
    }
    .geo-color-box {
      width: 10px;
      height: 10px;
      border-radius: 2px;
      border: 1px solid #9ca3af;
      margin-right: 4px;
    }
    .geo-mode {
      font-size: 11px;
      margin-top: 6px;
      color: #4b5563;
    }
    .geo-mode label {
      display: block;
      margin-top: 2px;
    }
    .geo-mode label:first-child {
      font-weight: 600;
      margin-top: 0;
    }
    .pill {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid #d1d5db;
      background: #ecfdf5;
      margin-left: 4px;
    }
    .section-title {
      margin-top: 12px;
      font-size: 15px;
      font-weight: 600;
    }
  </style>
</head>
<body>
<header>
  <div>
    <h1>Двоечники и успеваемость — 1 триместр, 9 классы</h1>
    <small>ТОПы муниципалитетов и школ, списки учеников и карта зон Московской области</small>
  </div>
</header>

<div class="container">
  <!-- ЛЕВАЯ ПАНЕЛЬ -->
  <div class="panel sidebar">
    <h2>Данные</h2>

    <label>Файл Excel (.xlsx):</label>
    <input type="file" id="file-input" accept=".xlsx" />
    <div class="hint">
      Ожидаются столбцы: «Округ», «Краткое название школы», «ФИО ученика», «GUID ученика», «Класс», «Предмет», «Оценка за период».
    </div>
    <div id="file-status" class="hint" style="margin-top:6px;"></div>

    <hr>

    <h2>Карта</h2>
    <label>GeoJSON с границами муниципалитетов:</label>
    <input type="file" id="geojson-input" accept=".geojson,.json" />
    <div class="hint">
      Границы МО Московской области. Названия должны совпадать (или почти совпадать) с столбцом «Округ» из Excel.
    </div>
    <div id="geojson-status" class="hint" style="margin-top:4px;"></div>

    <label for="geojson-prop">Поле с названием муниципалитета (GeoJSON)</label>
    <select id="geojson-prop">
      <option value="">— не выбрано —</option>
    </select>

    <hr>

    <h2>Фильтры (для списков учеников)</h2>

    <label for="filter-mu">Муниципалитет (Округ)</label>
    <select id="filter-mu">
      <option value="all">Все муниципалитеты</option>
    </select>

    <label for="filter-school">Школа</label>
    <select id="filter-school">
      <option value="all">Все школы</option>
    </select>

    <label for="filter-min-students">Мин. количество учеников в школе (для ТОПов школ)</label>
    <select id="filter-min-students">
      <option value="0">Не фильтровать</option>
      <option value="10">От 10 учеников</option>
      <option value="25">От 25 учеников</option>
      <option value="50">От 50 учеников</option>
    </select>

    <div class="hint">
      Фильтры работают только для списков учеников. ТОПы и карта считаются по всей области.
    </div>
    <div id="filter-warning" class="bad-news"></div>
  </div>

  <!-- ПРАВАЯ ПАНЕЛЬ -->
  <div class="panel">
    <h2>Итоги по области</h2>
    <div id="no-data-msg" class="bad-news">
      Загрузите Excel-файл, чтобы увидеть показатели.
    </div>

    <div id="dashboard-content" style="display:none;">

      <!-- KPI -->
      <div class="kpi-grid">
        <div class="kpi">
          <div class="kpi-label">Учеников всего</div>
          <div class="kpi-value" id="kpi-total-students">–</div>
          <div class="kpi-sub" id="kpi-total-schools">Школ: –</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Ученики с хоть одной двойкой</div>
          <div class="kpi-value" id="kpi-students-any2">–</div>
          <div class="kpi-sub" id="kpi-share-any2">Доля двоечников: –</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Ученики с ≥4 двоек</div>
          <div class="kpi-value" id="kpi-students-4plus">–</div>
          <div class="kpi-sub" id="kpi-share-4plus">Доля: –</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Всего двоек (2)</div>
          <div class="kpi-value" id="kpi-total-2s">–</div>
          <div class="kpi-sub" id="kpi-avg-2s-per-student">в среднем на ученика: –</div>
        </div>
      </div>

      <!-- 1. ТОПЫ 4+ ДВОЕК -->
      <div class="section-title">
        1. ТОП муниципалитетов и школ по ученикам с ≥4 двоек
      </div>

      <div class="main-grid-2">
        <div class="panel" style="padding:10px 12px;">
          <h3>Муниципалитеты — лучшие (меньше учеников с ≥4 двоек)</h3>
          <div class="table-wrapper">
            <table>
              <thead>
              <tr>
                <th>#</th>
                <th>Муниципалитет</th>
                <th>Школ</th>
                <th>Учеников всего</th>
                <th>Учеников с ≥4 двоек</th>
                <th>Доля, %</th>
                <th>Всего двоек у них</th>
              </tr>
              </thead>
              <tbody id="top-mu-4plus-best"></tbody>
            </table>
          </div>
        </div>
        <div class="panel" style="padding:10px 12px;">
          <h3>Муниципалитеты — худшие (больше учеников с ≥4 двоек)</h3>
          <div class="table-wrapper">
            <table>
              <thead>
              <tr>
                <th>#</th>
                <th>Муниципалитет</th>
                <th>Школ</th>
                <th>Учеников всего</th>
                <th>Учеников с ≥4 двоек</th>
                <th>Доля, %</th>
                <th>Всего двоек у них</th>
              </tr>
              </thead>
              <tbody id="top-mu-4plus-worst"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="main-grid-2" style="margin-top:12px;">
        <div class="panel" style="padding:10px 12px;">
          <h3>Школы — лучшие (меньше учеников с ≥4 двоек)</h3>
          <div class="table-wrapper">
            <table>
              <thead>
              <tr>
                <th>#</th>
                <th>Муниципалитет</th>
                <th>Школа</th>
                <th>Учеников всего</th>
                <th>Учеников с ≥4 двоек</th>
                <th>Доля, %</th>
                <th>Всего двоек у них</th>
              </tr>
              </thead>
              <tbody id="top-schools-4plus-best"></tbody>
            </table>
          </div>
          <div class="footer-note">
            Учитываются только школы с числом учащихся ≥ выбранного порога.
          </div>
        </div>
        <div class="panel" style="padding:10px 12px;">
          <h3>Школы — худшие (больше учеников с ≥4 двоек)</h3>
          <div class="table-wrapper">
            <table>
              <thead>
              <tr>
                <th>#</th>
                <th>Муниципалитет</th>
                <th>Школа</th>
                <th>Учеников всего</th>
                <th>Учеников с ≥4 двоек</th>
                <th>Доля, %</th>
                <th>Всего двоек у них</th>
              </tr>
              </thead>
              <tbody id="top-schools-4plus-worst"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- 2. Общий список школ по 4+ двоек -->
      <div class="section-title">
        2. Общий список: муниципалитет, школа, количество учеников с ≥4 двоек
      </div>
      <div class="panel" style="padding:10px 12px;">
        <div class="table-wrapper" style="max-height:260px;">
          <table>
            <thead>
            <tr>
              <th>Муниципалитет</th>
              <th>Школа</th>
              <th>Учеников всего</th>
              <th>Ученики с ≥4 двоек</th>
              <th>Доля, %</th>
              <th>Всего двоек у них</th>
            </tr>
            </thead>
            <tbody id="summary-4plus-by-school"></tbody>
          </table>
        </div>
      </div>

      <!-- 3. ТОПЫ по Русскому + Математика (двойки) -->
      <div class="section-title">
        3. ТОП по ученикам с двойкой по русскому и одной/несколькими двойками по математике
      </div>

      <div class="main-grid-2">
        <div class="panel" style="padding:10px 12px;">
          <h3>Муниципалитеты — лучшие (меньше таких учеников)</h3>
          <div class="table-wrapper">
            <table>
              <thead>
              <tr>
                <th>#</th>
                <th>Муниципалитет</th>
                <th>Школ</th>
                <th>Учеников всего</th>
                <th>Ученики с Рус+Мат</th>
                <th>Доля, %</th>
                <th>Всего двоек у них</th>
              </tr>
              </thead>
              <tbody id="top-mu-rusmath-best"></tbody>
            </table>
          </div>
        </div>
        <div class="panel" style="padding:10px 12px;">
          <h3>Муниципалитеты — худшие (больше таких учеников)</h3>
          <div class="table-wrapper">
            <table>
              <thead>
              <tr>
                <th>#</th>
                <th>Муниципалитет</th>
                <th>Школ</th>
                <th>Учеников всего</th>
                <th>Ученики с Рус+Мат</th>
                <th>Доля, %</th>
                <th>Всего двоек у них</th>
              </tr>
              </thead>
              <tbody id="top-mu-rusmath-worst"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="main-grid-2" style="margin-top:12px;">
        <div class="panel" style="padding:10px 12px;">
          <h3>Школы — лучшие (меньше учеников с Рус+Мат)</h3>
          <div class="table-wrapper">
            <table>
              <thead>
              <tr>
                <th>#</th>
                <th>Муниципалитет</th>
                <th>Школа</th>
                <th>Учеников всего</th>
                <th>Ученики с Рус+Мат</th>
                <th>Доля, %</th>
                <th>Всего двоек у них</th>
              </tr>
              </thead>
              <tbody id="top-schools-rusmath-best"></tbody>
            </table>
          </div>
          <div class="footer-note">
            Учитываются только школы с числом учащихся ≥ выбранного порога.
          </div>
        </div>
        <div class="panel" style="padding:10px 12px;">
          <h3>Школы — худшие (больше учеников с Рус+Мат)</h3>
          <div class="table-wrapper">
            <table>
              <thead>
              <tr>
                <th>#</th>
                <th>Муниципалитет</th>
                <th>Школа</th>
                <th>Учеников всего</th>
                <th>Ученики с Рус+Мат</th>
                <th>Доля, %</th>
                <th>Всего двоек у них</th>
              </tr>
              </thead>
              <tbody id="top-schools-rusmath-worst"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- 4. Списки учеников по топам -->
      <div class="section-title">
        4. Списки учеников по критериям
      </div>
      <div class="panel" style="padding:10px 12px;">
        <div class="footer-note">
          Фильтры слева (муниципалитет, школа) сужают списки ниже.
        </div>
        <h3>Ученики с ≥4 двоек</h3>
        <div class="table-wrapper" style="max-height:220px;">
          <table>
            <thead>
            <tr>
              <th>Муниципалитет</th>
              <th>Школа</th>
              <th>ФИО</th>
              <th>Класс</th>
              <th>Кол-во двоек</th>
              <th>Предметы с двойками</th>
            </tr>
            </thead>
            <tbody id="students-4plus"></tbody>
          </table>
        </div>

        <h3 style="margin-top:10px;">Ученики с двойкой по русскому и двойкой(ами) по математике</h3>
        <div class="table-wrapper" style="max-height:220px;">
          <table>
            <thead>
            <tr>
              <th>Муниципалитет</th>
              <th>Школа</th>
              <th>ФИО</th>
              <th>Класс</th>
              <th>Кол-во двоек</th>
              <th>Предметы с двойками</th>
            </tr>
            </thead>
            <tbody id="students-rusmath"></tbody>
          </table>
        </div>
      </div>

      <!-- 5–7. Отличники / хорошисты без 2 и 3 -->
      <div class="section-title">
        5–7. ТОПы по «уникальным» детям без оценок 2 и 3
      </div>
      <div class="panel" style="padding:10px 12px;">
        <div class="footer-note">
          Категории считаются по всем предметам ученика:
          <span class="pill">Только 5</span> — есть пятёрки, нет 2, 3 и 4;
          <span class="pill">Только 4</span> — есть четвёрки, нет 2, 3 и 5;
          <span class="pill">Только 4 и 5</span> — есть и 4, и 5, нет 2 и 3.
        </div>

        <h3>5. Уникальные дети с только оценками 5</h3>
        <div class="main-grid-2">
          <div class="table-wrapper">
            <table>
              <thead>
              <tr>
                <th>#</th>
                <th>Муниципалитет</th>
                <th>Школ</th>
                <th>Ученики всего</th>
                <th>Уникальные «5»</th>
                <th>Доля, %</th>
              </tr>
              </thead>
              <tbody id="top-mu-high5-best"></tbody>
            </table>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
              <tr>
                <th>#</th>
                <th>Муниципалитет</th>
                <th>Школа</th>
                <th>Ученики всего</th>
                <th>Уникальные «5»</th>
                <th>Доля, %</th>
              </tr>
              </thead>
              <tbody id="top-schools-high5-best"></tbody>
            </table>
          </div>
        </div>

        <h3 style="margin-top:10px;">6. Уникальные дети с только оценками 4</h3>
        <div class="main-grid-2">
          <div class="table-wrapper">
            <table>
              <thead>
              <tr>
                <th>#</th>
                <th>Муниципалитет</th>
                <th>Школ</th>
                <th>Ученики всего</th>
                <th>Уникальные «4»</th>
                <th>Доля, %</th>
              </tr>
              </thead>
              <tbody id="top-mu-high4-best"></tbody>
            </table>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
              <tr>
                <th>#</th>
                <th>Муниципалитет</th>
                <th>Школа</th>
                <th>Ученики всего</th>
                <th>Уникальные «4»</th>
                <th>Доля, %</th>
              </tr>
              </thead>
              <tbody id="top-schools-high4-best"></tbody>
            </table>
          </div>
        </div>

        <h3 style="margin-top:10px;">7. Уникальные дети с только оценками 4 и 5</h3>
        <div class="main-grid-2">
          <div class="table-wrapper">
            <table>
              <thead>
              <tr>
                <th>#</th>
                <th>Муниципалитет</th>
                <th>Школ</th>
                <th>Ученики всего</th>
                <th>Уникальные «4+5»</th>
                <th>Доля, %</th>
              </tr>
              </thead>
              <tbody id="top-mu-high45-best"></tbody>
            </table>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
              <tr>
                <th>#</th>
                <th>Муниципалитет</th>
                <th>Школа</th>
                <th>Ученики всего</th>
                <th>Уникальные «4+5»</th>
                <th>Доля, %</th>
              </tr>
              </thead>
              <tbody id="top-schools-high45-best"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- 8. Карта -->
      <div class="section-title">
        8. Карта Московской области по выбранному показателю
      </div>
      <div class="panel" style="margin-top:4px; padding:10px 12px;">
        <h3>Показатель для карты</h3>
        <div class="geo-mode" id="indicator-radios">
          <label>Выберите метрику (используется и для ранжирования муниципалитетов на карте):</label>
          <label>
            <input type="radio" name="indicator" value="four_plus" checked>
            Ученики с ≥4 двоек
          </label>
          <label>
            <input type="radio" name="indicator" value="rus_math">
            Ученики с двойкой по русскому и двойкой(ами) по математике
          </label>
          <label>
            <input type="radio" name="indicator" value="high_5_only">
            Уникальные дети с только 5 (без 2, 3, 4)
          </label>
          <label>
            <input type="radio" name="indicator" value="high_4_only">
            Уникальные дети с только 4 (без 2, 3, 5)
          </label>
          <label>
            <input type="radio" name="indicator" value="high_4_and_5">
            Уникальные дети с только 4 и 5 (без 2 и 3)
          </label>
        </div>
        <div class="footer-note" id="indicator-description">
          Сейчас выбран: <b>Ученики с ≥4 двоек</b>.
        </div>

        <h3 style="margin-top:10px;">Карта зон</h3>
        <div class="hint">
          Карта делит муниципалитеты на три группы по доле выбранной категории учеников:<br>
          зелёная зона — лучшая треть (меньше «проблемных» или больше «успешных» детей),<br>
          жёлтая — средняя треть, красная — худшая треть. Цвет карты базово зелёный, группы идут к красному по мере ухудшения показателя.
        </div>

        <div id="geo-map"></div>
        <div class="geo-legend">
          <div id="geo-legend-mode">
            Показатель: ученики с ≥4 двоек.
          </div>
          <span><span class="geo-color-box" style="background:#22c55e"></span>Зелёная зона (лучшая треть)</span>
          <span><span class="geo-color-box" style="background:#facc15"></span>Жёлтая зона (средняя треть)</span>
          <span><span class="geo-color-box" style="background:#ef4444"></span>Красная зона (худшая треть)</span>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  // ===== ГЛОБАЛЬНЫЕ ДАННЫЕ =====
  const EXCEL_URL = "results_1trim_9grade.xlsx";
  const GEOJSON_URL = "mo_municipalities.geojson.geojson";

  let allRecords = [];   // исходные строки журнала
  let allStudents = [];  // агрегировано по ученикам
  let schoolStatsAll = [];
  let muStatsAll = [];

  let currentFilters = {
    municipality: "all",
    school: "all",
    minStudents: 0
  };

  // текущий выбранный показатель для карты
  let currentIndicator = "four_plus";

  const INDICATORS = [
    {
      key: "four_plus",
      label: "Ученики с ≥4 двоек",
      desc: "Ученики, у которых суммарно 4 и более двоек по любым предметам.",
    },
    {
      key: "rus_math",
      label: "Двойка по русскому + математика",
      desc: "Ученики, у которых есть двойка по русскому языку и хотя бы одна двойка по математике (алгебра, геометрия, вероятность/статистика).",
    },
    {
      key: "high_5_only",
      label: "Только оценки 5",
      desc: "Ученики, у которых по всем предметам только оценки 5 (нет 2, 3 и 4).",
    },
    {
      key: "high_4_only",
      label: "Только оценки 4",
      desc: "Ученики, у которых по всем предметам только оценки 4 (нет 2, 3 и 5).",
    },
    {
      key: "high_4_and_5",
      label: "Только оценки 4 и 5",
      desc: "Ученики, у которых есть и 4, и 5 и нет оценок 2 и 3.",
    }
  ];

  const INDICATOR_BY_KEY = {};
  INDICATORS.forEach(i => { INDICATOR_BY_KEY[i.key] = i; });

  // Ключи для агрегирования (включая any2 для KPI)
  const CAT_KEYS = ["four_plus", "rus_math", "high_5_only", "high_4_only", "high_4_and_5", "any2"];

  // КАРТА
  let geoJsonData = null;
  let geoMap = null;
  let geoJsonLayer = null;
  let geoMunicipalityProp = "";

  // ===== УТИЛИТЫ =====
  function formatInt(v) {
    if (v == null || isNaN(v)) return "0";
    return Number(v).toLocaleString("ru-RU");
  }

  function formatPercent(value) {
    if (value == null || isNaN(value)) return "–";
    return value.toFixed(1).replace(".", ",");
  }

  function safeGet(obj, key) {
    return (obj && Object.prototype.hasOwnProperty.call(obj, key)) ? obj[key] : undefined;
  }

  function findColumnName(sampleRow, candidates) {
    const keys = Object.keys(sampleRow || {});
    for (const c of candidates) {
      if (keys.includes(c)) return c;
    }
    const lowerKeys = keys.map(k => k.toLowerCase());
    for (const c of candidates) {
      const lc = c.toLowerCase();
      const idx = lowerKeys.findIndex(k => k.includes(lc));
      if (idx >= 0) return keys[idx];
    }
    return null;
  }

  // нормализация названий МО
  function normalizeMuName(name) {
    if (!name) return "";
    let s = name.toString().toLowerCase();

    s = s.replace(/ё/g, "е");

    s = s.replace(/городской округ/g, "");
    s = s.replace(/муниципальный район/g, "");
    s = s.replace(/муниципальный округ/g, "");
    s = s.replace(/муниципальное образование/g, "");
    s = s.replace(/муниципальный город/g, "");
    s = s.replace(/муниципальный/g, "");

    s = s.replace(/\bг\.\s*/g, "");
    s = s.replace(/\bгород\b/g, "");
    s = s.replace(/\bр-он\b/g, "");
    s = s.replace(/\bр-н\b/g, "");
    s = s.replace(/\bрайон\b/g, "");
    s = s.replace(/\bокруг\b/g, "");
    s = s.replace(/\bпоселение\b/g, "");
    s = s.replace(/\bпос\b/g, "");

    s = s.replace(/\bобласть\b/g, "");

    s = s.replace(/[«»"']/g, "");
    s = s.replace(/\(.*?\)/g, "");
    s = s.replace(/-/g, " ");
    s = s.replace(/\s+/g, " ").trim();

    return s;
  }

  function zoneLabel(z) {
    if (z === "green") return "Зелёная";
    if (z === "yellow") return "Жёлтая";
    if (z === "red") return "Красная";
    return "Нет данных";
  }

  function classifySubjectGroup(subj) {
    if (!subj) return null;
    const s = subj.toLowerCase();
    if (s.includes("русск")) return "rus";
    if (s.includes("алгебр")) return "alg";
    if (s.includes("геометр")) return "geom";
    if (s.includes("вероят") || s.includes("статист")) return "prob";
    return null;
  }

  // ===== ПАРСИНГ EXCEL =====
  function handleFile(file) {
    document.getElementById("file-status").textContent = "Чтение файла...";
    const reader = new FileReader();
    reader.onload = (evt) => {
      const data = new Uint8Array(evt.target.result);
      const workbook = XLSX.read(data, { type: "array" });
      parseWorkbook(workbook, file.name);
    };
    reader.onerror = () => {
      document.getElementById("file-status").textContent = "Ошибка чтения файла.";
    };
    reader.readAsArrayBuffer(file);
  }

  function parseWorkbook(workbook, fileName) {
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });

    if (!rows || !rows.length) {
      document.getElementById("file-status").textContent =
        "В файле нет данных (пустой лист).";
      return;
    }

    const sample = rows[0];

    const muCol = findColumnName(sample, ["Округ", "Муниципалитет", "Ваш муниципалитет"]);
    const schoolCol = findColumnName(sample, ["Краткое название школы", "Школа", "Наименование образовательной организации"]);
    const studentCol = findColumnName(sample, ["ФИО ученика", "ФИО"]);
    const studentIdCol = findColumnName(sample, ["GUID ученика", "GUID", "ID ученика"]);
    const classCol = findColumnName(sample, ["Класс"]);
    const subjectCol = findColumnName(sample, ["Предмет"]);
    const gradeCol = findColumnName(sample, ["Оценка за период", "Оценка"]);

    if (!muCol || !schoolCol || !studentCol || !classCol || !subjectCol || !gradeCol) {
      document.getElementById("file-status").textContent =
        "Не удалось найти нужные столбцы. Проверь, что структура Excel соответствует выгрузке (Округ, школа, ФИО, класс, предмет, оценка).";
      return;
    }

    allRecords = rows.map(r => {
      const municipality = (safeGet(r, muCol) || "").toString().trim();
      const schoolName = (safeGet(r, schoolCol) || "").toString().trim();
      const studentName = (safeGet(r, studentCol) || "").toString().trim();
      const studentIdRaw = studentIdCol ? (safeGet(r, studentIdCol) || "").toString().trim() : "";
      const className = (safeGet(r, classCol) || "").toString().trim();
      const subject = (safeGet(r, subjectCol) || "").toString().trim();
      const gradeCell = safeGet(r, gradeCol);

      let gradeNum = null;
      if (gradeCell !== "" && gradeCell !== null && gradeCell !== undefined) {
        if (typeof gradeCell === "number") {
          gradeNum = gradeCell;
        } else {
          const s = gradeCell.toString().replace(",", ".").trim();
          const v = parseFloat(s);
          if (!isNaN(v)) gradeNum = v;
        }
      }

      const studentId = studentIdRaw || (studentName + "||" + className);

      return {
        municipality,
        schoolName,
        studentName,
        studentId,
        className,
        subject,
        grade: gradeNum
      };
    }).filter(r => r.municipality && r.schoolName && r.studentName);

    if (!allRecords.length) {
      document.getElementById("file-status").textContent =
        "После очистки пустых строк данных не осталось.";
      return;
    }

    document.getElementById("file-status").textContent =
      "Файл загружен: " + fileName;

    document.getElementById("no-data-msg").style.display = "none";
    document.getElementById("dashboard-content").style.display = "block";

    buildStudentLevelData();
    buildAggregates();
    initFilters();
    applyFiltersAndRender();
    renderGeoLayer();
  }

  // ===== ПО УЧЕНИКАМ =====
  function buildStudentLevelData() {
    const perStudent = {};

    allRecords.forEach(rec => {
      const key = rec.municipality + "||" + rec.schoolName + "||" + rec.studentId;
      if (!perStudent[key]) {
        perStudent[key] = {
          municipality: rec.municipality,
          schoolName: rec.schoolName,
          studentId: rec.studentId,
          studentName: rec.studentName,
          className: rec.className,
          totalGrades: 0,
          numTwos: 0,
          twosBySubject: {},
          hasRus2: false,
          hasAlg2: false,
          hasGeom2: false,
          hasProb2: false,
          has2: false,
          has3: false,
          has4: false,
          has5: false
        };
      }
      const s = perStudent[key];

      if (rec.grade != null && !isNaN(rec.grade)) {
        s.totalGrades += 1;
        const g = rec.grade;

        if (g === 2) {
          s.numTwos += 1;
          s.has2 = true;
          s.twosBySubject[rec.subject] = (s.twosBySubject[rec.subject] || 0) + 1;

          const gr = classifySubjectGroup(rec.subject);
          if (gr === "rus")  s.hasRus2 = true;
          if (gr === "alg")  s.hasAlg2 = true;
          if (gr === "geom") s.hasGeom2 = true;
          if (gr === "prob") s.hasProb2 = true;
        } else if (g === 3) {
          s.has3 = true;
        } else if (g === 4) {
          s.has4 = true;
        } else if (g === 5) {
          s.has5 = true;
        }
      }
    });

    allStudents = Object.values(perStudent).map(st => {
      const total2 = st.numTwos;
      const hasRus2 = st.hasRus2;
      const hasMath2 = st.hasAlg2 || st.hasGeom2 || st.hasProb2;

      const has2 = st.has2;
      const has3 = st.has3;
      const has4 = st.has4;
      const has5 = st.has5;

      const categories = {
        four_plus: total2 >= 4,
        rus_math: hasRus2 && hasMath2,
        any2: has2,
        high_5_only: has5 && !has4 && !has3 && !has2,
        high_4_only: has4 && !has5 && !has3 && !has2,
        high_4_and_5: has4 && has5 && !has2 && !has3
      };

      return { ...st, categories };
    });
  }

  // ===== АГРЕГАТЫ ПО ШКОЛАМ И МУНИЦИПАЛИТЕТАМ =====
  function buildAggregates() {
    const schoolMap = {};
    const muMap = {};

    allStudents.forEach(st => {
      const mu = st.municipality;
      const sch = st.schoolName;
      const keySchool = mu + "||" + sch;

      if (!schoolMap[keySchool]) {
        const base = {
          municipality: mu,
          schoolName: sch,
          totalStudents: 0
        };
        CAT_KEYS.forEach(k => {
          base[k + "_students"] = 0;
          base[k + "_twos"] = 0;   // для категорий по двойкам
          base[k + "_share"] = null;
        });
        schoolMap[keySchool] = base;
      }
      const ss = schoolMap[keySchool];
      ss.totalStudents += 1;

      CAT_KEYS.forEach(k => {
        if (st.categories[k]) {
          ss[k + "_students"] += 1;
          // двойки считаем только там, где они есть; для high_* будут просто 0
          ss[k + "_twos"] += st.numTwos;
        }
      });

      if (!muMap[mu]) {
        const base = {
          municipality: mu,
          totalStudents: 0,
          schoolNames: new Set()
        };
        CAT_KEYS.forEach(k => {
          base[k + "_students"] = 0;
          base[k + "_twos"] = 0;
          base[k + "_share"] = null;
        });
        muMap[mu] = base;
      }
      const ms = muMap[mu];
      ms.totalStudents += 1;
      ms.schoolNames.add(sch);

      CAT_KEYS.forEach(k => {
        if (st.categories[k]) {
          ms[k + "_students"] += 1;
          ms[k + "_twos"] += st.numTwos;
        }
      });
    });

    schoolStatsAll = Object.values(schoolMap).map(s => {
      if (s.totalStudents > 0) {
        CAT_KEYS.forEach(k => {
          s[k + "_share"] = (s[k + "_students"] / s.totalStudents) * 100;
        });
      }
      return s;
    });

    muStatsAll = Object.values(muMap).map(m => {
      m.schoolCount = m.schoolNames.size;
      delete m.schoolNames;
      if (m.totalStudents > 0) {
        CAT_KEYS.forEach(k => {
          m[k + "_share"] = (m[k + "_students"] / m.totalStudents) * 100;
        });
      }
      return m;
    });

    // зоны для карты по каждому индикатору
    ["four_plus", "rus_math", "high_5_only", "high_4_only", "high_4_and_5"].forEach(key => {
      const shareProp = key + "_share";
      const zoneProp = "zone_" + key;

      const sorted = muStatsAll
        .slice()
        .filter(m => m[shareProp] != null)
        .sort((a, b) => a[shareProp] - b[shareProp]);

      const n = sorted.length;
      if (n === 0) return;

      sorted.forEach((m, idx) => {
        const frac = idx / n;
        if (frac < 1 / 3) {
          m[zoneProp] = "green";
        } else if (frac < 2 / 3) {
          m[zoneProp] = "yellow";
        } else {
          m[zoneProp] = "red";
        }
      });

      muStatsAll.forEach(m => {
        if (!m[zoneProp]) m[zoneProp] = "green"; // закрашиваем «серое» в зелёный как по умолчанию
      });
    });
  }

  // ===== ФИЛЬТРЫ =====
  function initFilters() {
    const muSelect = document.getElementById("filter-mu");
    const schoolSelect = document.getElementById("filter-school");
    const minSelect = document.getElementById("filter-min-students");

    const municipalities = Array.from(new Set(schoolStatsAll.map(s => s.municipality)))
      .sort((a, b) => a.localeCompare(b, "ru"));

    muSelect.innerHTML = '<option value="all">Все муниципалитеты</option>';
    municipalities.forEach(mu => {
      const opt = document.createElement("option");
      opt.value = mu;
      opt.textContent = mu;
      muSelect.appendChild(opt);
    });

    function updateSchoolFilterList() {
      const mu = currentFilters.municipality;
      const schoolsFiltered = schoolStatsAll.filter(s =>
        mu === "all" ? true : s.municipality === mu
      );
      const schoolNames = Array.from(new Set(schoolsFiltered.map(s => s.schoolName)))
        .sort((a, b) => a.localeCompare(b, "ru"));

      schoolSelect.innerHTML = '<option value="all">Все школы</option>';
      schoolNames.forEach(sch => {
        const opt = document.createElement("option");
        opt.value = sch;
        opt.textContent = sch;
        schoolSelect.appendChild(opt);
      });
    }

    muSelect.onchange = () => {
      currentFilters.municipality = muSelect.value;
      currentFilters.school = "all";
      schoolSelect.value = "all";
      updateSchoolFilterList();
      applyFiltersAndRender();
    };

    schoolSelect.onchange = () => {
      currentFilters.school = schoolSelect.value;
      applyFiltersAndRender();
    };

    minSelect.onchange = () => {
      currentFilters.minStudents = parseInt(minSelect.value, 10) || 0;
      applyFiltersAndRender();
    };

    updateSchoolFilterList();
  }

  // ===== ОСНОВНОЙ РЕНДЕР =====
  function applyFiltersAndRender() {
    const { municipality, school } = currentFilters;
    document.getElementById("filter-warning").textContent = "";

    const filteredStudents = allStudents.filter(st => {
      if (municipality !== "all" && st.municipality !== municipality) return false;
      if (school !== "all" && st.schoolName !== school) return false;
      return true;
    });

    if (!filteredStudents.length) {
      document.getElementById("filter-warning").textContent =
        "По выбранным фильтрам нет данных.";
    }

    renderKPI(filteredStudents);
    renderTopBlocks();
    renderSummary4Plus();
    renderStudentLists(filteredStudents);
    renderHighAchievers();
    renderGeoLayer();
  }

  // ===== KPI =====
  function renderKPI(filteredStudents) {
    const schoolSet = new Set();

    let totalStudents = filteredStudents.length;
    let studentsAny2 = 0;
    let students4plus = 0;
    let totalTwos = 0;

    filteredStudents.forEach(st => {
      schoolSet.add(st.schoolName);
      if (st.categories.any2) {
        studentsAny2 += 1;
        totalTwos += st.numTwos;
      }
      if (st.categories.four_plus) {
        students4plus += 1;
      }
    });

    const shareAny2 = totalStudents > 0 ? (studentsAny2 / totalStudents) * 100 : null;
    const share4plus = totalStudents > 0 ? (students4plus / totalStudents) * 100 : null;
    const avgTwosPerStudent = totalStudents > 0 ? totalTwos / totalStudents : null;

    document.getElementById("kpi-total-students").textContent = formatInt(totalStudents);
    document.getElementById("kpi-total-schools").textContent = "Школ: " + formatInt(schoolSet.size);

    document.getElementById("kpi-students-any2").textContent = formatInt(studentsAny2);
    document.getElementById("kpi-share-any2").textContent =
      "Доля двоечников: " + formatPercent(shareAny2) + " %";

    document.getElementById("kpi-students-4plus").textContent = formatInt(students4plus);
    document.getElementById("kpi-share-4plus").textContent =
      "Доля: " + formatPercent(share4plus) + " %";

    document.getElementById("kpi-total-2s").textContent = formatInt(totalTwos);
    document.getElementById("kpi-avg-2s-per-student").textContent =
      "в среднем на ученика: " + formatPercent(avgTwosPerStudent || 0);
  }

  // ===== ТОПЫ (универсальная функция) =====
  function renderTopMunicipalitiesByCategory(catKey, bestBodyId, worstBodyId) {
    const bestBody = document.getElementById(bestBodyId);
    const worstBody = document.getElementById(worstBodyId);
    if (!bestBody || !worstBody) return;
    bestBody.innerHTML = "";
    worstBody.innerHTML = "";

    const studentsProp = catKey + "_students";
    const shareProp = catKey + "_share";
    const twosProp = catKey + "_twos";

    const sorted = muStatsAll
      .slice()
      .filter(m => m.totalStudents > 0)
      .sort((a, b) => {
        const aShare = a[shareProp] ?? 9999;
        const bShare = b[shareProp] ?? 9999;
        if (aShare !== bShare) return aShare - bShare;
        if (a[studentsProp] !== b[studentsProp]) return a[studentsProp] - b[studentsProp];
        return a.municipality.localeCompare(b.municipality, "ru");
      });

    if (!sorted.length) {
      bestBody.innerHTML = '<tr><td colspan="7">Нет данных по муниципалитетам.</td></tr>';
      worstBody.innerHTML = '<tr><td colspan="7">Нет данных по муниципалитетам.</td></tr>';
      return;
    }

    const topN = Math.min(10, sorted.length);
    const bottomN = Math.min(10, sorted.length);

    for (let i = 0; i < topN; i++) {
      const m = sorted[i];
      const tr = document.createElement("tr");
      tr.innerHTML =
        `<td>${i + 1}</td>` +
        `<td>${m.municipality}</td>` +
        `<td>${formatInt(m.schoolCount)}</td>` +
        `<td>${formatInt(m.totalStudents)}</td>` +
        `<td>${formatInt(m[studentsProp])}</td>` +
        `<td>${formatPercent(m[shareProp])}%</td>` +
        `<td>${m[twosProp] !== undefined ? formatInt(m[twosProp]) : "–"}</td>`;
      bestBody.appendChild(tr);
    }

    for (let i = 0; i < bottomN; i++) {
      const m = sorted[sorted.length - 1 - i];
      const rank = i + 1;
      const tr = document.createElement("tr");
      tr.innerHTML =
        `<td>${rank}</td>` +
        `<td>${m.municipality}</td>` +
        `<td>${formatInt(m.schoolCount)}</td>` +
        `<td>${formatInt(m.totalStudents)}</td>` +
        `<td>${formatInt(m[studentsProp])}</td>` +
        `<td>${formatPercent(m[shareProp])}%</td>` +
        `<td>${m[twosProp] !== undefined ? formatInt(m[twosProp]) : "–"}</td>`;
      worstBody.appendChild(tr);
    }
  }

  function renderTopSchoolsByCategory(catKey, bestBodyId, worstBodyId) {
    const bestBody = document.getElementById(bestBodyId);
    const worstBody = document.getElementById(worstBodyId);
    if (!bestBody || !worstBody) return;
    bestBody.innerHTML = "";
    worstBody.innerHTML = "";

    const studentsProp = catKey + "_students";
    const shareProp = catKey + "_share";
    const twosProp = catKey + "_twos";

    const minStudents = currentFilters.minStudents || 0;

    const sorted = schoolStatsAll
      .slice()
      .filter(s => s.totalStudents >= minStudents)
      .sort((a, b) => {
        const aShare = a[shareProp] ?? 9999;
        const bShare = b[shareProp] ?? 9999;
        if (aShare !== bShare) return aShare - bShare;
        if (a[studentsProp] !== b[studentsProp]) return a[studentsProp] - b[studentsProp];
        return a.schoolName.localeCompare(b.schoolName, "ru");
      });

    if (!sorted.length) {
      bestBody.innerHTML = '<tr><td colspan="7">Нет школ, удовлетворяющих порогу по числу учеников.</td></tr>';
      worstBody.innerHTML = '<tr><td colspan="7">Нет школ, удовлетворяющих порогу по числу учеников.</td></tr>';
      return;
    }

    const topN = Math.min(10, sorted.length);
    const bottomN = Math.min(10, sorted.length);

    for (let i = 0; i < topN; i++) {
      const s = sorted[i];
      const tr = document.createElement("tr");
      tr.innerHTML =
        `<td>${i + 1}</td>` +
        `<td>${s.municipality}</td>` +
        `<td>${s.schoolName}</td>` +
        `<td>${formatInt(s.totalStudents)}</td>` +
        `<td>${formatInt(s[studentsProp])}</td>` +
        `<td>${formatPercent(s[shareProp])}%</td>` +
        `<td>${s[twosProp] !== undefined ? formatInt(s[twosProp]) : "–"}</td>`;
      bestBody.appendChild(tr);
    }

    for (let i = 0; i < bottomN; i++) {
      const s = sorted[sorted.length - 1 - i];
      const rank = i + 1;
      const tr = document.createElement("tr");
      tr.innerHTML =
        `<td>${rank}</td>` +
        `<td>${s.municipality}</td>` +
        `<td>${s.schoolName}</td>` +
        `<td>${formatInt(s.totalStudents)}</td>` +
        `<td>${formatInt(s[studentsProp])}</td>` +
        `<td>${formatPercent(s[shareProp])}%</td>` +
        `<td>${s[twosProp] !== undefined ? formatInt(s[twosProp]) : "–"}</td>`;
      worstBody.appendChild(tr);
    }
  }

  function renderTopBlocks() {
    // 4+ двоек
    renderTopMunicipalitiesByCategory("four_plus", "top-mu-4plus-best", "top-mu-4plus-worst");
    renderTopSchoolsByCategory("four_plus", "top-schools-4plus-best", "top-schools-4plus-worst");

    // Рус+мат
    renderTopMunicipalitiesByCategory("rus_math", "top-mu-rusmath-best", "top-mu-rusmath-worst");
    renderTopSchoolsByCategory("rus_math", "top-schools-rusmath-best", "top-schools-rusmath-worst");
  }

  // ===== Общий список по 4+ двоек =====
  function renderSummary4Plus() {
    const tbody = document.getElementById("summary-4plus-by-school");
    if (!tbody) return;
    tbody.innerHTML = "";

    const rows = schoolStatsAll
      .slice()
      .filter(s => s["four_plus_students"] > 0)
      .sort((a, b) => {
        const muCmp = a.municipality.localeCompare(b.municipality, "ru");
        if (muCmp !== 0) return muCmp;
        return a.schoolName.localeCompare(b.schoolName, "ru");
      });

    if (!rows.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = '<td colspan="6">Нет школ с учениками с ≥4 двоек.</td>';
      tbody.appendChild(tr);
      return;
    }

    rows.forEach(s => {
      const tr = document.createElement("tr");
      tr.innerHTML =
        `<td>${s.municipality}</td>` +
        `<td>${s.schoolName}</td>` +
        `<td>${formatInt(s.totalStudents)}</td>` +
        `<td>${formatInt(s["four_plus_students"])}</td>` +
        `<td>${formatPercent(s["four_plus_share"])}%</td>` +
        `<td>${formatInt(s["four_plus_twos"])}</td>`;
      tbody.appendChild(tr);
    });
  }

  // ===== Списки учеников =====
  function renderStudentListByCategory(filteredStudents, catKey, tbodyId) {
    const tbody = document.getElementById(tbodyId);
    if (!tbody) return;
    tbody.innerHTML = "";

    const rows = filteredStudents.filter(st => st.categories[catKey]);

    if (!rows.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = '<td colspan="6">По выбранным фильтрам нет учеников по этому критерию.</td>';
      tbody.appendChild(tr);
      return;
    }

    rows
      .slice()
      .sort((a, b) => {
        if (b.numTwos !== a.numTwos) return b.numTwos - a.numTwos;
        const muCmp = a.municipality.localeCompare(b.municipality, "ru");
        if (muCmp !== 0) return muCmp;
        const schCmp = a.schoolName.localeCompare(b.schoolName, "ru");
        if (schCmp !== 0) return schCmp;
        const clsCmp = a.className.localeCompare(b.className, "ru");
        if (clsCmp !== 0) return clsCmp;
        return a.studentName.localeCompare(b.studentName, "ru");
      })
      .forEach(st => {
        const subjectsList = Object.keys(st.twosBySubject || {})
          .sort((a, b) => a.localeCompare(b, "ru"))
          .map(sub => `${sub} (${st.twosBySubject[sub]})`)
          .join(", ");

        const tr = document.createElement("tr");
        tr.innerHTML =
          `<td>${st.municipality}</td>` +
          `<td>${st.schoolName}</td>` +
          `<td>${st.studentName}</td>` +
          `<td>${st.className}</td>` +
          `<td>${formatInt(st.numTwos)}</td>` +
          `<td>${subjectsList || "—"}</td>`;
        tbody.appendChild(tr);
      });
  }

  function renderStudentLists(filteredStudents) {
    renderStudentListByCategory(filteredStudents, "four_plus", "students-4plus");
    renderStudentListByCategory(filteredStudents, "rus_math", "students-rusmath");
  }

  // ===== Отличники / хорошисты =====
  function renderHighAchievers() {
    renderTopMunicipalitiesByCategory("high_5_only", "top-mu-high5-best", "top-mu-high5-best"); // худших не требуется, используем один список
    renderTopSchoolsByCategory("high_5_only", "top-schools-high5-best", "top-schools-high5-best");

    renderTopMunicipalitiesByCategory("high_4_only", "top-mu-high4-best", "top-mu-high4-best");
    renderTopSchoolsByCategory("high_4_only", "top-schools-high4-best", "top-schools-high4-best");

    renderTopMunicipalitiesByCategory("high_4_and_5", "top-mu-high45-best", "top-mu-high45-best");
    renderTopSchoolsByCategory("high_4_and_5", "top-schools-high45-best", "top-schools-high45-best");
  }

  // ===== КАРТА =====
  function initGeoMap() {
    if (geoMap) return;
    geoMap = L.map("geo-map", {
      center: [55.5, 38.5],
      zoom: 7,
      zoomControl: true,
      attributionControl: false
    });
    setTimeout(() => geoMap.invalidateSize(), 100);
  }

  function handleGeoJsonFile(file) {
    document.getElementById("geojson-status").textContent = "Чтение GeoJSON...";
    const reader = new FileReader();
    reader.onload = (evt) => {
      try {
        const json = JSON.parse(evt.target.result);
        geoJsonData = json;
        document.getElementById("geojson-status").textContent =
          "GeoJSON загружен: " + file.name;
        initGeoMap();
        initGeoPropertySelector();
        renderGeoLayer();
      } catch (e) {
        document.getElementById("geojson-status").textContent =
          "Ошибка: не удалось разобрать GeoJSON.";
      }
    };
    reader.onerror = () => {
      document.getElementById("geojson-status").textContent =
        "Ошибка чтения GeoJSON.";
    };
    reader.readAsText(file, "utf-8");
  }

  function initGeoPropertySelector() {
    const propSelect = document.getElementById("geojson-prop");
    propSelect.innerHTML = '<option value="">— не выбрано —</option>';

    if (!geoJsonData || !geoJsonData.features || !geoJsonData.features.length) {
      document.getElementById("geojson-status").textContent =
        "GeoJSON не содержит объектов.";
      return;
    }

    const firstProps = geoJsonData.features[0].properties || {};
    const keys = Object.keys(firstProps);
    if (!keys.length) {
      document.getElementById("geojson-status").textContent =
        "В GeoJSON нет свойств (properties).";
      return;
    }

    keys.forEach((k) => {
      const opt = document.createElement("option");
      opt.value = k;
      opt.textContent = k;
      propSelect.appendChild(opt);
    });

    let guessed = "";
    const lowerKeys = keys.map((k) => k.toLowerCase());
    const candidates = ["name", "nameru", "muni", "municip", "mu_name", "raion", "okrug", "округ"];
    for (const c of candidates) {
      const idx = lowerKeys.findIndex((k) => k.includes(c));
      if (idx >= 0) {
        guessed = keys[idx];
        break;
      }
    }
    if (!guessed) guessed = keys[0];

    propSelect.value = guessed;
    geoMunicipalityProp = guessed;
  }

  function renderGeoLayer() {
    if (!geoJsonData) {
      document.getElementById("geojson-status").textContent =
        "Загрузите GeoJSON с границами муниципалитетов.";
      return;
    }
    if (!muStatsAll.length) {
      document.getElementById("geojson-status").textContent =
        "Сначала загрузите Excel с успеваемостью.";
      return;
    }

    initGeoMap();

    const propSelect = document.getElementById("geojson-prop");
    geoMunicipalityProp = propSelect.value || geoMunicipalityProp;
    if (!geoMunicipalityProp) {
      document.getElementById("geojson-status").textContent =
        "Выберите поле с названием муниципалитета (GeoJSON).";
      return;
    }

    document.getElementById("geojson-status").textContent =
      "GeoJSON загружен, поле: " + geoMunicipalityProp;

    if (geoJsonLayer) {
      geoMap.removeLayer(geoJsonLayer);
    }

    const statsByNorm = {};
    muStatsAll.forEach(m => {
      const key = normalizeMuName(m.municipality);
      if (key) statsByNorm[key] = m;
    });

    const zoneProp = "zone_" + currentIndicator;
    const studentsProp = currentIndicator + "_students";
    const shareProp = currentIndicator + "_share";
    const twosProp = currentIndicator + "_twos";

    function style(feature) {
      const props = feature.properties || {};
      const muName = (props[geoMunicipalityProp] || "").toString().trim();
      const norm = normalizeMuName(muName);
      const st = statsByNorm[norm];

      let zone = "green";
      if (st) {
        zone = st[zoneProp] || "green";
      }

      let fill = "#22c55e";
      if (zone === "yellow") fill = "#facc15";
      else if (zone === "red") fill = "#ef4444";

      return {
        color: "#15803d",
        weight: 1,
        fillColor: fill,
        fillOpacity: 0.8
      };
    }

    function onEachFeature(feature, layer) {
      const props = feature.properties || {};
      const muName = (props[geoMunicipalityProp] || "").toString().trim();
      const norm = normalizeMuName(muName);
      const st = statsByNorm[norm];

      let zone = "green";
      if (st) {
        zone = st[zoneProp] || "green";
      }

      let popupHtml = `<b>${muName || "Без названия"}</b><br>`;
      if (st) {
        popupHtml +=
          `Школ: ${formatInt(st.schoolCount)}<br>` +
          `Учеников всего: ${formatInt(st.totalStudents)}<br>` +
          `Ученики в выбранной группе: ${formatInt(st[studentsProp])}<br>` +
          `Доля в группе: ${formatPercent(st[shareProp])}%<br>` +
          (twosProp in st ? `Двоек у этих детей: ${formatInt(st[twosProp])}<br>` : "") +
          `Зона: <b>${zoneLabel(zone)}</b>`;
      } else {
        popupHtml += "Нет данных по этому муниципалитету.";
      }
      layer.bindPopup(popupHtml);

      layer.on({
        mouseover: function (e) {
          const l = e.target;
          l.setStyle({
            weight: 3,
            color: "#14532d",
            fillOpacity: 0.9
          });
          if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
            l.bringToFront();
          }
        },
        mouseout: function (e) {
          geoJsonLayer.resetStyle(e.target);
        }
      });
    }

    geoJsonLayer = L.geoJSON(geoJsonData, {
      style,
      onEachFeature
    }).addTo(geoMap);

    try {
      const bounds = geoJsonLayer.getBounds();
      geoMap.fitBounds(bounds, { maxZoom: 9, padding: [10, 10] });
      geoMap.setMaxBounds(bounds.pad(0.05));
    } catch (e) {}

    setTimeout(() => geoMap.invalidateSize(), 100);
  }

  // ===== СТАРТ / СОБЫТИЯ =====
  document.getElementById("file-input").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;
    handleFile(file);
  });

  document.getElementById("geojson-input").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;
    handleGeoJsonFile(file);
  });

  document.getElementById("geojson-prop").addEventListener("change", () => {
    renderGeoLayer();
  });

  document.querySelectorAll("input[name='indicator']").forEach(r => {
    r.addEventListener("change", (e) => {
      currentIndicator = e.target.value;
      const info = INDICATOR_BY_KEY[currentIndicator];
      const descDiv = document.getElementById("indicator-description");
      if (info && descDiv) {
        descDiv.innerHTML =
          `Сейчас выбран: <b>${info.label}</b>. ${info.desc}`;
      }
      const legendMode = document.getElementById("geo-legend-mode");
      if (legendMode && info) {
        legendMode.textContent = "Показатель: " + info.label + ".";
      }
      renderGeoLayer();
    });
  });

    // ===== АВТОЗАГРУЗКА ФАЙЛОВ С СЕРВЕРА =====
  async function loadExcelFromServer() {
    const status = document.getElementById("file-status");
    try {
      if (status) status.textContent = "Загружаю Excel с сервера...";
      const resp = await fetch(EXCEL_URL);
      if (!resp.ok) throw new Error("HTTP " + resp.status);

      const buf = await resp.arrayBuffer();
      const data = new Uint8Array(buf);
      const workbook = XLSX.read(data, { type: "array" });

      // твоя существующая функция разбора книги
      parseWorkbook(workbook, EXCEL_URL);

      if (status) status.textContent = "Excel загружен автоматически.";
    } catch (e) {
      console.error(e);
      if (status) {
        status.textContent = "Не удалось автоматически загрузить Excel. Можно выбрать файл вручную.";
      }
    }
  }

  async function loadGeoJsonFromServer() {
    const status = document.getElementById("geojson-status");
    try {
      if (status) status.textContent = "Загружаю GeoJSON с сервера...";
      const resp = await fetch(GEOJSON_URL);
      if (!resp.ok) throw new Error("HTTP " + resp.status);

      const json = await resp.json();
      geoJsonData = json;

      if (status) status.textContent = "GeoJSON загружен автоматически.";

      // твои функции для карты
      initGeoMap();
      initGeoPropertySelector();
      renderGeoLayer();
    } catch (e) {
      console.error(e);
      if (status) {
        status.textContent = "Не удалось автоматически загрузить GeoJSON. Можно выбрать файл вручную.";
      }
    }
  }

  window.addEventListener("load", () => {
    // при загрузке страницы сразу грузим файлы
    loadExcelFromServer();
    loadGeoJsonFromServer();
  });
</script>
</body>
</html>
